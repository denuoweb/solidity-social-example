<template>
  <v-card>
    <v-container fluid grid-list-md>
      <v-flex xs6 offset-xs3>
        <v-card-title class="justify-center">
          AltChat
        </v-card-title>
      </v-flex>
    </v-container>
    <v-tabs centered icons-and-text color="transparent" slider-color="indigo darken-4" v-model="active">
      <v-tab ripple @click="reset">New
        <v-icon>verified_user</v-icon>
      </v-tab>
      <v-tab-item>
        <v-card flat>
          <v-container fluid grid-list-md>
            <v-flex xs6 offset-xs3>
              <v-card-text>
                <v-form>
                  <h2 class="headline">Upload:</h2>
                  <br>
                  <div class="text-xs-center file">
                    <input type="file" @change="uploadFile" ref="file">
                    <div>
                      <v-btn flat icon color="blue" @click="$refs.file.click()">
                        <v-icon x-large>cloud_upload</v-icon>
                      </v-btn>
                    </div>
                    <span>{{loadStatus}}%</span>
                    <span @click="removeFile" class="remove-file" v-show="isFile">
                      <v-icon color="red accent-4">delete_forever</v-icon>
                    </span>
                  </div>
                  <br>
                  <div class="text-xs-center">or</div>
                  <br>
                  <v-textarea 
                    label="Text" 
                    v-model="text" 
                    :readonly="isFile" 
                    @keyup="textHash" 
                    outline
                    background-color="indigo"
                  ></v-textarea>
                  <v-text-field 
                    label="File name:" 
                    v-model="fileName" 
                    v-if="isFile" 
                    readonly 
                    outline
                    background-color="indigo"
                  ></v-text-field>
                  <v-text-field 
                    label="File size:" 
                    v-model="fileSize" 
                    v-if="isFile" 
                    readonly 
                    outline
                    background-color="indigo"
                  ></v-text-field>
                  <br>
                  <br>
                  <v-text-field 
                    label="Generated Hash:" 
                    v-model="hashID" 
                    readonly 
                    outline
                    background-color="indigo"
                  >
                  </v-text-field>
                  <br>
                  <br>
                  <v-layout>
                    <v-flex xs4>
                      <v-text-field
                        label="Gas Price (1e-8 HTML/gas)"
                        v-model.trim="gasPrice"
                        required
                        outline
                        background-color="deep-purple darken-1"
                      ></v-text-field>
                    </v-flex>
                    <v-flex xs4>
                      <v-text-field
                        label="Gas Limit"
                        v-model.trim="gasLimit"
                        required
                        outline
                        background-color="deep-purple darken-1"
                      ></v-text-field>
                    </v-flex>
                    <v-flex xs4>
                      <v-text-field
                        label="Fee"
                        v-model.trim="fee"
                        required
                        outline
                        background-color="deep-purple darken-1"
                      ></v-text-field>
                    </v-flex>
                  </v-layout>
                </v-form>
              </v-card-text>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn
                  class="info"
                  @click="send"
                  :disabled="notValid"
                >{{ $t('common.confirm') }}</v-btn>
                <v-spacer></v-spacer>
              </v-card-actions>
              <v-dialog v-model="confirmSendDialog" persistent max-width="50%">
                <v-card>
                  <v-card-title>
                    <span class="headline">{{ $t('send_to_contract.confirm') }}</span>
                  </v-card-title>
                  <v-card-text>
                    <v-container grid-list-md>

                      <v-layout wrap v-if="text==''">
                        <v-flex xs12>
                          <b>Please store the file info below in a safe place, as it contains the unique ID for this content registration.</b>
                        </v-flex>
                        <v-flex xs10>
                          <v-text-field label="File Name and Hash" v-model="fileInfo" disabled>
                          </v-text-field>
                        </v-flex>
                        <v-flex xs2>
                          <v-btn
                            small
                            class="mt-3"
                            color="cyan"
                            v-clipboard:copy="fileInfo"
                            v-clipboard:success="onCopySucc"
                            v-clipboard:error="onCopyError"
                          >{{ $t('common.copy') }}</v-btn>
                        </v-flex>
                        <v-flex xs12>
                          <v-text-field label="Raw Tx" v-model="rawTx" disabled></v-text-field>
                        </v-flex>
                      </v-layout>

                      <v-layout wrap v-else>
                        <v-flex xs12>
                          <b>Please store the hash below in a safe place, as it is the unique ID for this content registration.</b>
                        </v-flex>
                        <v-flex xs10>
                          <v-text-field label="Text Hash" v-model="hashID" disabled>
                          </v-text-field>
                        </v-flex>
                        <v-flex xs2>
                          <v-btn
                            small
                            class="mt-3"
                            color="cyan"
                            v-clipboard:copy="hashID"
                            v-clipboard:success="onCopySucc"
                            v-clipboard:error="onCopyError"
                          >{{ $t('common.copy') }}</v-btn>
                        </v-flex>
                        <v-flex xs12>
                          <v-text-field label="Raw Tx" v-model="rawTx" disabled></v-text-field>
                        </v-flex>
                      </v-layout>

                    </v-container>
                  </v-card-text>
                  <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn
                      class="blue--text darken-1"
                      flat
                      @click="confirmSend"
                      v-show="canSend && !sending"
                    >{{ $t('common.confirm') }}</v-btn>
                    <v-btn
                      class="red--text darken-1"
                      flat
                      @click.native="confirmSendDialog = false"
                      :v-show="!sending"
                    >{{ $t('common.cancel') }}</v-btn>
                    <v-progress-circular
                      indeterminate
                      :size="50"
                      v-show="sending"
                      class="primary--text"
                    ></v-progress-circular>
                  </v-card-actions>
                </v-card>
              </v-dialog>
            </v-flex>
          </v-container>
        </v-card>
      </v-tab-item>
    </v-tabs>
    <v-dialog
      v-model="loading"
      hide-overlay
      persistent
      width="300"
    >
      <v-card
        color="indigo darken-1"
        dark
      >
        <v-card-text>
          Please stand by
          <v-progress-linear
            indeterminate
            color="white"
            class="mb-0"
          ></v-progress-linear>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-card>
</template>

<style lang="less">
.headline {
  img {
    max-height: 150px;
  }
}

.file {
  border: dashed 3px #90caf9;
  position: relative;
  padding: 5px 0;

  input[type="file"] {
    display: none;
  }

  .loading {
    background-color: #42a5f5;
    left: 0px;
    height: 100%;
    position: absolute;
    top: 0;
    opacity: 0.3;
  }

  .remove-file {
    position: absolute;
    right: 5px;
    top: 5px;
    cursor: pointer;
  }
}
</style>

<script>
import webWallet from "libs/web-wallet";
import abi from "ethjs-abi";
import server from "libs/server";
import sha256 from "js-sha256";
import qrcode from "qrcode";
import config from "libs/config";

const abiJson = JSON.parse(
  '[{"constant":true,"inputs":[{"name":"hash","type":"string"}],"name":"getDocument","outputs":[{"name":"stored","type":"bool"},{"name":"blockNumber","type":"uint256"},{"name":"blockTimestamp","type":"uint256"},{"name":"sender","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"hash","type":"string"}],"name":"newDocument","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":false,"name":"blockNumber","type":"uint256"},{"indexed":false,"name":"hash","type":"string"}],"name":"DocumentEvent","type":"event"}]'
);

const contractAddress = config.getNetwork() == "mainnet" ? "5034f90f0fae1f0ab3c8f5385b556b65308cd8ac" : "73ff16a4066702fb58ac775427b5aae905b2ab1e";

export default {
  data() {
    return {
      loading: false,
      abi: "",
      parsedAbi: null,
      method: null,
      inputParams: [],
      fullName: "",
      motherFullName: "",
      fatherFullName: "",
      dateOfBirth_menu: false,
      dateOfBirth: "",
      timeOfBirth_menu: false,
      timeOfBirth: null,
      timePicker: false,
      placeOfBirth: "",
      gasPrice: "40",
      gasLimit: "2500000",
      fee: "0.01",
      confirmSendDialog: false,
      execResultDialog: false,
      rawTx: "loading...",
      canSend: false,
      sending: false,
      hashID: "",
      searchHashID: "",
      qr: "",
      file: null,
      fileName: "",
      fileSize: "",
      text: "",
      loadStatus: 0,
      blockNumber: 0,
      blockTimestamp: 0,
      fileNameSearch: "",
      textSearch: "",
      active: null
    };
  },
  computed: {
    notValid: function() {
      //@todo valid the address
      const gasPriceCheck =
        /^\d+\.?\d*$/.test(this.gasPrice) && this.gasPrice > 0;
      const gasLimitCheck =
        /^\d+\.?\d*$/.test(this.gasLimit) && this.gasLimit > 0;
      const feeCheck = /^\d+\.?\d*$/.test(this.fee) && this.fee > 0.0001;

      const hashID = this.hashID !== "";

      return !(gasPriceCheck && gasLimitCheck && feeCheck && hashID);
    },
    isFile() {
      return this.fileName !== "";
    }
  },
  watch: {
    method: function() {
      this.inputParams = [];
    }
  },
  methods: {
    async send() {
      try {
        const encodedData = abi
          .encodeMethod(abiJson[1], [this.hashID])
          .substr(2);
        this.confirmSendDialog = true;
        try {
          this.rawTx = await webWallet
            .getWallet()
            .generateSendToContractTx(
              contractAddress,
              encodedData,
              this.gasLimit,
              this.gasPrice,
              this.fee
            );
        } catch (e) {
          this.$root.log.error(
            "send_to_generate_tx_error",
            e.stack || e.toString() || e
          );
          alert(e.message || e);
          this.confirmSendDialog = false;
          return false;
        }
        this.canSend = true;
      } catch (e) {
        this.$root.error("Params error");
        this.$root.log.error(
          "send_to_contract_encode_abi_error",
          e.stack || e.toString() || e
        );
        this.confirmSendDialog = false;
        return false;
      }
    },
    async confirmSend() {
      this.sending = true;
      try {
        const txId = await webWallet.getWallet().sendRawTx(this.rawTx);
        this.confirmSendDialog = false;
        this.sending = false;
        const txViewUrl = server.currentNode().getTxExplorerUrl(txId);
        this.$root.success(
          `Successful sent! You can follow the transaction on <a href="${txViewUrl}" target="_blank">${txViewUrl}</a>`,
          true,
          0
        );
        this.$emit("send");
        this.removeFile();

        this.text = "";
      } catch (e) {
        alert(e.message || e);
        this.$root.log.error(
          "send_to_contract_post_raw_tx_error",
          e.response || e.stack || e.toString() || e
        );
        this.confirmSendDialog = false;
      }
    },
    async uploadFile(event = null) {
      try {
        this.active === 1 ? (this.hashID = "") : (this.searchHashID = "");

        let file = event.target.files[0];

        if(typeof file === 'undefined') 
          return; 

        this.textSearch = "";
        this.text = "";

        if (file.size > 1024 * 1024 * 500)
          throw new Error(
            `The max size of the file should have 500 MegaBytes! "File name: ${
              file.name
            } - Size: ${this.formatSize(file.size)}"`
          );

        this.fileSize = this.formatSize(file.size);

        const fileBinaryString = await this.fileReader(file);
        this.parseHash(fileBinaryString);
        
        this.fileName = file.name;

        this.fileInfo = "File name: " + file.name + " - File hash: " + this.hashID;

        
      } catch (err) {
        this.$root.error(err.message);
        this.$root.log.error(
          "call_contract_encode_abi_error",
          err.stack || err.toString() || err
        );
      }
    },
    async reprocessHash() {
      if (this.file && this.text === "") await this.uploadFile();
      else if (this.text && this.file === null) this.textHash();
    },
    parseHash(hash) {
      if (this.active === 1) this.hashID = hash !== "" ? sha256(hash) : "";
      else this.searchHashID = hash !== "" ? sha256(hash) : "";
    },
    textHash() {
      this.parseHash(this.text);
    },
    removeFile() {
      this.fileName = "";
      this.fileSize = "";
      this.hashID = "";
      this.loadStatus = 0;
      this.$refs.file.value = null;
    },
    textHashSearch() {
      this.parseHash(this.textSearch);
    },
    reset() {
      this.removeFile();
      this.textSearch = "";
      this.searchHashID = "";
    },
    removeFileSearch() {
      this.searchHashID = "";
      this.fileName = "";
      this.loadStatus = 0;
      this.$refs.fileSearch.value = null;
    }
  }
};
</script>
